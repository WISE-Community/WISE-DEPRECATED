{"version":3,"sources":["notebookReport.es6"],"names":["NotebookReportController","$filter","$mdSidenav","$scope","$timeout","AnnotationService","ConfigService","NotebookService","ProjectService","$translate","full","collapsed","dirty","autoSaveInterval","saveMessage","text","time","reportId","config","itemTypes","report","notes","reportItem","getLatestNotebookReportItemByReportId","workgroupId","serverSaveTime","clientSaveTime","convertToClientTimestamp","setSaveMessage","getTemplateReportItemByReportId","maxScore","localNotebookItemId","content","reportNoteContent","getReportNoteContentByReportId","id","reportItemContent","injectAssetPaths","latestAnnotations","getLatestNotebookItemAnnotations","startAutoSaveInterval","summernoteOptions","toolbar","popover","image","customButton","buttonText","note","label","singular","tooltip","buttonClass","action","$event","addNotebookItemContent","disableDragAndDrop","toolbarContainer","callbacks","onBlur","$","summernote","$onChanges","changes","insertContent","isFirstChange","currentValue","item","angular","copy","reportElement","$item","groups","length","attr","hasAttachments","attachments","css","a","notebookItemAttachment","iconURL","$img","addClass","append","$caption","$on","event","args","annotation","hasNewAnnotation","collapse","$notebookReportContent","animate","scrollTop","prop","onCollapse","onSetInsertMode","value","requester","removeAbsoluteAssetPaths","stopAutoSaveInterval","autoSaveIntervalId","setInterval","saveNotebookReportItem","clearInterval","Date","parse","saveNotebookItem","nodeId","type","title","then","result","message","$inject","NotebookReport","bindings","insertMode","visible","template","controller"],"mappings":"AAAA;;;;;;;;;;IAEMA,wB;AACJ,oCAAYC,OAAZ,EACYC,UADZ,EAEYC,MAFZ,EAGYC,QAHZ,EAIYC,iBAJZ,EAKYC,aALZ,EAMYC,eANZ,EAOYC,cAPZ,EAO4B;AAAA;;AAAA;;AAC1B,SAAKP,OAAL,GAAeA,OAAf;AACA,SAAKC,UAAL,GAAkBA,UAAlB;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,QAAL,GAAgBA,QAAhB;AACA,SAAKC,iBAAL,GAAyBA,iBAAzB;AACA,SAAKC,aAAL,GAAqBA,aAArB;AACA,SAAKC,eAAL,GAAuBA,eAAvB;AACA,SAAKC,cAAL,GAAsBA,cAAtB;AACA,SAAKC,UAAL,GAAkB,KAAKR,OAAL,CAAa,WAAb,CAAlB;AACA,SAAKS,IAAL,GAAY,KAAZ;AACA,SAAKC,SAAL,GAAiB,IAAjB;AACA,SAAKC,KAAL,GAAa,KAAb;AACA,SAAKC,gBAAL,GAAwB,KAAxB,CAb0B,CAaM;AAChC,SAAKC,WAAL,GAAmB;AACjBC,YAAM,EADW;AAEjBC,YAAM;AAFW,KAAnB;;AAKA;AACA,SAAKC,QAAL,GAAgB,KAAKC,MAAL,CAAYC,SAAZ,CAAsBC,MAAtB,CAA6BC,KAA7B,CAAmC,CAAnC,EAAsCJ,QAAtD;AACA,SAAKK,UAAL,GAAkB,KAAKf,eAAL,CAAqBgB,qCAArB,CAA2D,KAAKN,QAAhE,EAA0E,KAAKO,WAA/E,CAAlB;AACA,QAAI,KAAKF,UAAT,EAAqB;AACnB,UAAIG,iBAAiB,KAAKH,UAAL,CAAgBG,cAArC;AACA,UAAIC,iBAAiB,KAAKpB,aAAL,CAAmBqB,wBAAnB,CAA4CF,cAA5C,CAArB;AACA,WAAKG,cAAL,CAAoB,KAAKnB,UAAL,CAAgB,OAAhB,CAApB,EAA8CiB,cAA9C;AACD,KAJD,MAIO;AACL;AACA,WAAKJ,UAAL,GAAkB,KAAKf,eAAL,CAAqBsB,+BAArB,CAAqD,KAAKZ,QAA1D,CAAlB;AACA,UAAI,KAAKK,UAAL,IAAmB,IAAvB,EAA6B;AAC3B;AACA;AACD;AACF;AACD,SAAKQ,QAAL,GAAgB,CAAhB;AACA,QAAIC,sBAAsB,IAA1B,CAnC0B,CAmCO;AACjC,QAAI,KAAKT,UAAL,CAAgBU,OAAhB,IAA2B,IAA3B,IAAmC,KAAKV,UAAL,CAAgBU,OAAhB,CAAwBf,QAAxB,IAAoC,IAA3E,EAAiF;AAC/Ec,4BAAsB,KAAKT,UAAL,CAAgBS,mBAAtC;AACA,UAAIE,oBAAoB,KAAK1B,eAAL,CAAqB2B,8BAArB,CAAoD,KAAKZ,UAAL,CAAgBU,OAAhB,CAAwBf,QAA5E,CAAxB;AACA,UAAIgB,qBAAqB,IAArB,IAA6BA,kBAAkBH,QAAlB,IAA8B,IAA/D,EAAqE;AACnE,aAAKA,QAAL,GAAgBG,kBAAkBH,QAAlC;AACD;AACF;;AAED,SAAKR,UAAL,CAAgBa,EAAhB,GAAqB,IAArB,CA5C0B,CA4CC;AAC3B,SAAKC,iBAAL,GAAyB,KAAK5B,cAAL,CAAoB6B,gBAApB,CAAqC,KAAKf,UAAL,CAAgBU,OAAhB,CAAwBA,OAA7D,CAAzB;AACA,SAAKM,iBAAL,GAAyB,KAAKjC,iBAAL,CAAuBkC,gCAAvB,CAAwD,KAAKf,WAA7D,EAA0E,KAAKP,QAA/E,CAAzB;AACA,SAAKuB,qBAAL;;AAEA,SAAKC,iBAAL,GAAyB;AACvBC,eAAS,CACP,CAAC,MAAD,EAAS,CAAC,MAAD,EAAS,MAAT,CAAT,CADO,EAEP,CAAC,OAAD,EAAU,CAAC,MAAD,EAAS,QAAT,EAAmB,WAAnB,CAA8B,0DAA9B,CAAV,CAFO;AAGP;AACA;AACA;AACA;AACA,OAAC,MAAD,EAAS,CAAC,IAAD,EAAO,IAAP,EAAa,WAAb,CAAwB,kBAAxB,CAAT,CAPO;AAQP;AACA;AACA;AACA;AACA;AACA,OAAC,cAAD,EAAiB,CAAC,cAAD,CAAjB,CAbO,EAcP,CAAC,OAAD,EAAU,CAAC,OAAD,CAAV,CAdO,CADc;AAiBvBC,eAAS;AACPC,eAAO,CACL,CAAC,WAAD,EAAc,CAAC,cAAD,EAAiB,aAAjB,EAAgC,aAAhC,CAAd,CADK;AAEL;AACA,SAAC,QAAD,EAAW,CAAC,aAAD,CAAX,CAHK;AADA,OAjBc;AAwBvBC,oBAAc;AACZ;AACAC,oBAAY,YAAY,KAAK5B,MAAL,CAAYC,SAAZ,CAAsB4B,IAAtB,CAA2BC,KAA3B,CAAiCC,QAA7C,GAAwD,IAFxD;AAGZC,iBAAS,iBAAiB,KAAKhC,MAAL,CAAY8B,KAH1B;AAIZG,qBAAa,0CAJD;AAKZC,gBAAQ,gBAACC,MAAD,EAAY;AAClB,gBAAKC,sBAAL,CAA4BD,MAA5B;AACD;AAPW,OAxBS;AAiCvBE,0BAAoB,IAjCG;AAkCvBC,wBAAkB,MAAM,KAAKvC,QAAX,GAAsB,UAlCjB;AAmCvBwC,iBAAW;AACTC,gBAAQ,kBAAY;AAClBC,YAAE,IAAF,EAAQC,UAAR,CAAmB,WAAnB;AACD;AAHQ;AAnCY,KAAzB;;AA0CA,SAAKC,UAAL,GAAkB,UAACC,OAAD,EAAa;AAC7B,UAAIA,QAAQC,aAAR,IAAyB,CAACD,QAAQC,aAAR,CAAsBC,aAAtB,EAA1B,IAAmEF,QAAQC,aAAR,CAAsBE,YAA7F,EAA2G;AACzG,YAAIC,OAAOC,QAAQC,IAAR,CAAaN,QAAQC,aAAR,CAAsBE,YAAnC,CAAX;AACA,YAAII,gBAAgBV,EAAE,MAAM,MAAK1C,QAAb,CAApB;AACAoD,sBAAcT,UAAd,CAAyB,OAAzB;AACAS,sBAAcT,UAAd,CAAyB,cAAzB;AACA,YAAIU,QAAQX,4BAA0BO,KAAK/B,EAA/B,wBAAoD+B,KAAK1C,WAAzD,QAAZ;AACA,YAAI0C,KAAKK,MAAL,IAAe,IAAf,IAAuBL,KAAKK,MAAL,CAAYC,MAAZ,GAAqB,CAAhD,EAAmD;AACjDF,gBAAMG,IAAN,CAAW,OAAX,EAAoBP,KAAKK,MAAzB;AACD;AACD,YAAIG,iBAAiB,KAArB;AACA,YAAIR,KAAKlC,OAAT,EAAkB;AAChB,cAAIkC,KAAKlC,OAAL,CAAa2C,WAAjB,EAA8B;AAC5B,gBAAIT,KAAKlC,OAAL,CAAa2C,WAAb,CAAyBH,MAA7B,EAAqC;AACnCE,+BAAiB,IAAjB;AACA;AACAJ,oBAAMM,GAAN,CAAU,YAAV,EAAwB,QAAxB;AACD;AACD,iBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIX,KAAKlC,OAAL,CAAa2C,WAAb,CAAyBH,MAA7C,EAAqDK,GAArD,EAA0D;AACxD;AACA,kBAAIC,yBAAyBZ,KAAKlC,OAAL,CAAa2C,WAAb,CAAyBE,CAAzB,CAA7B;AACA,kBAAIE,UAAUD,uBAAuBC,OAArC;AACA,kBAAIC,OAAOrB,EAAE,eAAeoB,OAAf,GAAyB,2IAA3B,CAAX;AACAC,mBAAKC,QAAL,CAAc,iCAAd;AACAX,oBAAMY,MAAN,CAAaF,IAAb;AACD;AACF;AACD,cAAId,KAAKlC,OAAL,CAAajB,IAAjB,EAAuB;AACrB,gBAAI2D,cAAJ,EAAoB;AAClB;AACA,kBAAIS,WAAWxB,EAAE,aAAaO,KAAKlC,OAAL,CAAajB,IAA1B,GAAiC,YAAnC,EAAiD6D,GAAjD,CAAqD,EAAC,cAAc,QAAf,EAArD,CAAf;AACAN,oBAAMY,MAAN,CAAaC,QAAb;AACAd,4BAAcT,UAAd,CAAyB,YAAzB,EAAuCU,MAAM,CAAN,CAAvC;AACD,aALD,MAKO;AACLD,4BAAcT,UAAd,CAAyB,YAAzB,EAAuCM,KAAKlC,OAAL,CAAajB,IAApD;AACD;AACF,WATD,MASO;AACLsD,0BAAcT,UAAd,CAAyB,YAAzB,EAAuCU,MAAM,CAAN,CAAvC;AACD;AACF;AACF;AACF,KAzCD;;AA2CA;;;;AAIA,SAAKnE,MAAL,CAAYiF,GAAZ,CAAgB,gCAAhB,EAAkD,UAACC,KAAD,EAAQC,IAAR,EAAiB;AACjE,UAAIC,aAAaD,KAAKC,UAAtB;AACA,UAAIA,WAAWxD,mBAAX,KAAmC,MAAKd,QAA5C,EAAsD;AACpD,cAAKuE,gBAAL,GAAwB,IAAxB;AACA,cAAKlD,iBAAL,GAAyB,MAAKjC,iBAAL,CAAuBkC,gCAAvB,CAAwD,MAAKf,WAA7D,EAA0E,MAAKP,QAA/E,CAAzB;AACD;AACF,KAND;;AAQA;;;;AAIA,SAAKd,MAAL,CAAYiF,GAAZ,CAAgB,uBAAhB,EAAyC,UAACE,IAAD,EAAU;AACjD,UAAI,MAAK3E,SAAT,EAAoB;AAClB,cAAK8E,QAAL;AACD;;AAED;AACA,UAAIC,yBAAyB/B,EAAE,2BAAF,CAA7B;AACAvD,eAAS,YAAM;AACbsF,+BAAuBC,OAAvB,CAA+B;AAC7BC,qBAAWF,uBAAuBG,IAAvB,CAA4B,cAA5B;AADkB,SAA/B,EAEG,GAFH;AAGD,OAJD,EAIG,GAJH;AAKD,KAZD;AAaD;;;;+BAEU;AACT,WAAKlF,SAAL,GAAiB,CAAC,KAAKA,SAAvB;;AAEA,UAAI,KAAKA,SAAT,EAAoB;AAClB,aAAKmF,UAAL;AACD;AACF;;;iCAEY;AACX,UAAI,KAAKnF,SAAT,EAAoB;AAClB,aAAKD,IAAL,GAAY,IAAZ;AACA,aAAKC,SAAL,GAAiB,KAAjB;AACD,OAHD,MAGO;AACL,aAAKD,IAAL,GAAY,CAAC,KAAKA,IAAlB;AACD;AACF;;;2CAEsB2C,M,EAAQ;AAC7B,WAAK0C,eAAL,CAAqB,EAACC,OAAO,IAAR,EAAcC,WAAW,QAAzB,EAArB;AACD;;;4BAEOD,K,EAAO;AACb,WAAKpF,KAAL,GAAa,IAAb;;AAEA;;;;;;;AAOA,WAAKU,UAAL,CAAgBU,OAAhB,CAAwBA,OAAxB,GAAkC,KAAK1B,aAAL,CAAmB4F,wBAAnB,CAA4CF,KAA5C,CAAlC;AACD;;;4CAEuB;AAAA;;AACtB,WAAKG,oBAAL;AACA,WAAKC,kBAAL,GAA0BC,YAAY,YAAM;AAC1C,YAAI,OAAKzF,KAAT,EAAgB;AACd,iBAAK0F,sBAAL;AACD;AACF,OAJyB,EAIvB,KAAKzF,gBAJkB,CAA1B;AAKD;;;2CAEsB;AACrB0F,oBAAc,KAAKH,kBAAnB;AACD;;;6CAEwB;AAAA;;AACvB,WAAK9E,UAAL,CAAgBU,OAAhB,CAAwBN,cAAxB,GAAyC8E,KAAKC,KAAL,CAAW,IAAID,IAAJ,EAAX,CAAzC,CADuB,CAC2C;AAClE,WAAKjG,eAAL,CAAqBmG,gBAArB,CAAsC,KAAKpF,UAAL,CAAgBa,EAAtD,EAA0D,KAAKb,UAAL,CAAgBqF,MAA1E,EAAkF,KAAKrF,UAAL,CAAgBS,mBAAlG,EACE,KAAKT,UAAL,CAAgBsF,IADlB,EACwB,KAAKtF,UAAL,CAAgBuF,KADxC,EAC+C,KAAKvF,UAAL,CAAgBU,OAD/D,EACwE,KAAKV,UAAL,CAAgBiD,MADxF,EACgG,KAAKjD,UAAL,CAAgBU,OAAhB,CAAwBN,cADxH,EAEGoF,IAFH,CAEQ,UAACC,MAAD,EAAY;AAChB,YAAIA,MAAJ,EAAY;AACV,iBAAKnG,KAAL,GAAa,KAAb;AACA,iBAAK4E,gBAAL,GAAwB,KAAxB;AACA,iBAAKlE,UAAL,CAAgBa,EAAhB,GAAqB4E,OAAO5E,EAA5B,CAHU,CAGsB;AAChC,cAAIV,iBAAiBsF,OAAOtF,cAA5B;AACA,cAAIC,iBAAiB,OAAKpB,aAAL,CAAmBqB,wBAAnB,CAA4CF,cAA5C,CAArB;AACA,iBAAKG,cAAL,CAAoB,OAAKnB,UAAL,CAAgB,OAAhB,CAApB,EAA8CiB,cAA9C;AACD;AACF,OAXH;AAYD;;;mCAEcsF,O,EAAShG,I,EAAM;AAC5B,WAAKF,WAAL,CAAiBC,IAAjB,GAAwBiG,OAAxB;AACA,WAAKlG,WAAL,CAAiBE,IAAjB,GAAwBA,IAAxB;AACD;;;;;;AAGHhB,yBAAyBiH,OAAzB,GAAmC,CACjC,SADiC,EAEjC,YAFiC,EAGjC,QAHiC,EAIjC,UAJiC,EAKjC,mBALiC,EAMjC,eANiC,EAOjC,iBAPiC,EAQjC,gBARiC,CAAnC;;AAWA,IAAMC,iBAAiB;AACrBC,YAAU;AACRjG,YAAQ,GADA;AAER6C,mBAAe,GAFP;AAGRqD,gBAAY,GAHJ;AAIRnG,cAAU,GAJF;AAKRoG,aAAS,GALD;AAMR7F,iBAAa,GANL;AAORsE,gBAAY,GAPJ;AAQRC,qBAAiB;AACjB;AATQ,GADW;AAYrBuB,qkJAZqB;AAsErBC,cAAYvH;AAtES,CAAvB;;kBAyEekH,c","file":"notebookReport.js","sourcesContent":["\"use strict\";\n\nclass NotebookReportController {\n  constructor($filter,\n              $mdSidenav,\n              $scope,\n              $timeout,\n              AnnotationService,\n              ConfigService,\n              NotebookService,\n              ProjectService) {\n    this.$filter = $filter;\n    this.$mdSidenav = $mdSidenav;\n    this.$scope = $scope;\n    this.$timeout = $timeout;\n    this.AnnotationService = AnnotationService;\n    this.ConfigService = ConfigService;\n    this.NotebookService = NotebookService;\n    this.ProjectService = ProjectService;\n    this.$translate = this.$filter('translate');\n    this.full = false;\n    this.collapsed = true;\n    this.dirty = false;\n    this.autoSaveInterval = 30000;  // the auto save interval in milliseconds\n    this.saveMessage = {\n      text: '',\n      time: ''\n    };\n\n    // assume only one report for now\n    this.reportId = this.config.itemTypes.report.notes[0].reportId;\n    this.reportItem = this.NotebookService.getLatestNotebookReportItemByReportId(this.reportId, this.workgroupId);\n    if (this.reportItem) {\n      let serverSaveTime = this.reportItem.serverSaveTime;\n      let clientSaveTime = this.ConfigService.convertToClientTimestamp(serverSaveTime);\n      this.setSaveMessage(this.$translate('saved'), clientSaveTime);\n    } else {\n      // Student doesn't have work for this report yet, so we'll use the template.\n      this.reportItem = this.NotebookService.getTemplateReportItemByReportId(this.reportId);\n      if (this.reportItem == null) {\n        // if there is no template, don't allow student to work on the report.\n        return;\n      }\n    }\n    this.maxScore = 0;\n    let localNotebookItemId = null;  // unique id that is local to this student, that identifies a note and its revisions. e.g. \"finalReport\", \"xyzabc\"\n    if (this.reportItem.content != null && this.reportItem.content.reportId != null) {\n      localNotebookItemId = this.reportItem.localNotebookItemId;\n      let reportNoteContent = this.NotebookService.getReportNoteContentByReportId(this.reportItem.content.reportId);\n      if (reportNoteContent != null && reportNoteContent.maxScore != null) {\n        this.maxScore = reportNoteContent.maxScore;\n      }\n    }\n\n    this.reportItem.id = null; // set the id to null so it can be inserted as initial version, as opposed to updated. this is true for both new and just-loaded reports.\n    this.reportItemContent = this.ProjectService.injectAssetPaths(this.reportItem.content.content);\n    this.latestAnnotations = this.AnnotationService.getLatestNotebookItemAnnotations(this.workgroupId, this.reportId);\n    this.startAutoSaveInterval();\n\n    this.summernoteOptions = {\n      toolbar: [\n        ['edit', ['undo', 'redo']],\n        ['style', ['bold', 'italic', 'underline'/*, 'superscript', 'subscript', 'strikethrough', 'clear'*/]],\n        //['style', ['style']],\n        //['fontface', ['fontname']],\n        //['textsize', ['fontsize']],\n        //['fontclr', ['color']],\n        ['para', ['ul', 'ol', 'paragraph'/*, 'lineheight'*/]],\n        //['height', ['height']],\n        //['table', ['table']],\n        //['insert', ['link','picture','video','hr']],\n        //['view', ['fullscreen', 'codeview']],\n        //['help', ['help']]\n        ['customButton', ['customButton']],\n        ['print', ['print']]\n      ],\n      popover: {\n        image: [\n          ['imagesize', ['imageSize100', 'imageSize50', 'imageSize25']],\n          //['float', ['floatLeft', 'floatRight', 'floatNone']],\n          ['remove', ['removeMedia']]\n        ]\n      },\n      customButton: {\n        // TODO: i18n\n        buttonText: 'Insert ' + this.config.itemTypes.note.label.singular + ' +',\n        tooltip: 'Insert from ' + this.config.label,\n        buttonClass: 'accent-1 notebook-item--report__add-note',\n        action: ($event) => {\n          this.addNotebookItemContent($event);\n        }\n      },\n      disableDragAndDrop: true,\n      toolbarContainer: '#' + this.reportId + '-toolbar',\n      callbacks: {\n        onBlur: function () {\n          $(this).summernote('saveRange');\n        }\n      }\n    };\n\n    this.$onChanges = (changes) => {\n      if (changes.insertContent && !changes.insertContent.isFirstChange() && changes.insertContent.currentValue) {\n        let item = angular.copy(changes.insertContent.currentValue);\n        let reportElement = $('#' + this.reportId);\n        reportElement.summernote('focus');\n        reportElement.summernote('restoreRange');\n        let $item = $(`<p notebook-item-id=\"${item.id}\" workgroup-id=\"${item.workgroupId}\">`);\n        if (item.groups != null && item.groups.length > 0) {\n          $item.attr('group', item.groups);\n        }\n        let hasAttachments = false;\n        if (item.content) {\n          if (item.content.attachments) {\n            if (item.content.attachments.length) {\n              hasAttachments = true;\n              // item includes attachments, so center align element\n              $item.css('text-align', 'center');\n            }\n            for (let a = 0; a < item.content.attachments.length; a++) {\n              // add each attachment to the element\n              let notebookItemAttachment = item.content.attachments[a];\n              let iconURL = notebookItemAttachment.iconURL;\n              let $img = $('<img src=\"' + iconURL + '\" alt=\"notebook image\" style=\"width: 75%; max-width: 100%; height: auto; border: 1px solid #aaaaaa; padding: 8px; margin-bottom: 4px;\" />');\n              $img.addClass('notebook-item--report__note-img');\n              $item.append($img);\n            }\n          }\n          if (item.content.text) {\n            if (hasAttachments) {\n              // item has attachments, so treat text content as a caption: center it and make it bold\n              let $caption = $('<div><b>' + item.content.text + '</b></div>').css({'text-align': 'center'});\n              $item.append($caption);\n              reportElement.summernote('insertNode', $item[0]);\n            } else {\n              reportElement.summernote('insertText', item.content.text);\n            }\n          } else {\n            reportElement.summernote('insertNode', $item[0]);\n          }\n        }\n      }\n    }\n\n    /**\n     * Captures the annotation received event, checks whether the given\n     * annotation id matches this report id, updates UI accordingly\n     */\n    this.$scope.$on('notebookItemAnnotationReceived', (event, args) => {\n      let annotation = args.annotation;\n      if (annotation.localNotebookItemId === this.reportId) {\n        this.hasNewAnnotation = true;\n        this.latestAnnotations = this.AnnotationService.getLatestNotebookItemAnnotations(this.workgroupId, this.reportId);\n      }\n    });\n\n    /**\n     * Captures the show report annotations event, opens report (if collapsed)\n     * and scrolls to the report annotations display\n     */\n    this.$scope.$on('showReportAnnotations', (args) => {\n      if (this.collapsed) {\n        this.collapse();\n      }\n\n      // scroll to report annotations (bottom)\n      let $notebookReportContent = $('.notebook-report__content');\n      $timeout(() => {\n        $notebookReportContent.animate({\n          scrollTop: $notebookReportContent.prop('scrollHeight')\n        }, 500);\n      }, 500);\n    });\n  }\n\n  collapse() {\n    this.collapsed = !this.collapsed;\n\n    if (this.collapsed) {\n      this.onCollapse();\n    }\n  }\n\n  fullscreen() {\n    if (this.collapsed) {\n      this.full = true;\n      this.collapsed = false;\n    } else {\n      this.full = !this.full;\n    }\n  }\n\n  addNotebookItemContent($event) {\n    this.onSetInsertMode({value: true, requester: 'report'});\n  }\n\n  changed(value) {\n    this.dirty = true;\n\n    /*\n     * remove the absolute asset paths\n     * e.g.\n     * <img src='https://wise.berkeley.edu/curriculum/3/assets/sun.png'/>\n     * will be changed to\n     * <img src='sun.png'/>\n     */\n    this.reportItem.content.content = this.ConfigService.removeAbsoluteAssetPaths(value);\n  }\n\n  startAutoSaveInterval() {\n    this.stopAutoSaveInterval();\n    this.autoSaveIntervalId = setInterval(() => {\n      if (this.dirty) {\n        this.saveNotebookReportItem();\n      }\n    }, this.autoSaveInterval);\n  }\n\n  stopAutoSaveInterval() {\n    clearInterval(this.autoSaveIntervalId);\n  }\n\n  saveNotebookReportItem() {\n    this.reportItem.content.clientSaveTime = Date.parse(new Date());  // set save timestamp\n    this.NotebookService.saveNotebookItem(this.reportItem.id, this.reportItem.nodeId, this.reportItem.localNotebookItemId,\n      this.reportItem.type, this.reportItem.title, this.reportItem.content, this.reportItem.groups, this.reportItem.content.clientSaveTime)\n      .then((result) => {\n        if (result) {\n          this.dirty = false;\n          this.hasNewAnnotation = false;\n          this.reportItem.id = result.id; // set the reportNotebookItemId to the newly-incremented id so that future saves during this visit will be an update instead of an insert.\n          let serverSaveTime = result.serverSaveTime;\n          let clientSaveTime = this.ConfigService.convertToClientTimestamp(serverSaveTime);\n          this.setSaveMessage(this.$translate('saved'), clientSaveTime);\n        }\n      });\n  }\n\n  setSaveMessage(message, time) {\n    this.saveMessage.text = message;\n    this.saveMessage.time = time;\n  }\n}\n\nNotebookReportController.$inject = [\n  '$filter',\n  '$mdSidenav',\n  '$scope',\n  '$timeout',\n  'AnnotationService',\n  'ConfigService',\n  'NotebookService',\n  'ProjectService'\n];\n\nconst NotebookReport = {\n  bindings: {\n    config: '<',\n    insertContent: '<',\n    insertMode: '<',\n    reportId: '<',\n    visible: '<',\n    workgroupId: '<',\n    onCollapse: '&',\n    onSetInsertMode: '&'\n    //onClose: '&'\n  },\n  template:\n    `<div ng-if=\"($ctrl.visible && $ctrl.full && !$ctrl.collapsed) || $ctrl.insertMode\" class=\"notebook-report-backdrop\"></div>\n        <div ng-if=\"$ctrl.visible\" class=\"notebook-report-container\"\n              ng-class=\"{'notebook-report-container__collapsed': $ctrl.collapsed, 'notebook-report-container__full': $ctrl.full && !$ctrl.collapsed}\">\n            <md-card class=\"notebook-report md-whiteframe-3dp l-constrained\">\n                <md-toolbar ng-click=\"$ctrl.collapsed ? $ctrl.collapse() : return\" class=\"md-toolbar--wise md-toolbar--wise--sm notebook-report__toolbar\">\n                    <md-toolbar-tools class=\"md-toolbar-tools\">\n                        <md-icon>assignment</md-icon>&nbsp;\n                        <span ng-if=\"$ctrl.collapsed\" class=\"overflow--ellipsis notebook-report__toolbar__title\">{{$ctrl.reportItem.content.title}}</span>\n                        <span flex></span>\n                        <md-button aria-label=\"{{'toggleFullScreen' | translate}}\" title=\"{{'toggleFullScreen' | translate}}\" class=\"md-icon-button notebook-tools--full\"\n                                   ng-click=\"$ctrl.fullscreen()\">\n                            <md-icon ng-if=\"!$ctrl.full || $ctrl.collapsed\"> fullscreen </md-icon>\n                            <md-icon ng-if=\"$ctrl.full && !$ctrl.collapsed\"> fullscreen_exit </md-icon>\n                        </md-button>\n                        <md-button aria-label=\"{{'collapse' | translate}}\" title=\"{{'collapse' | translate}}\" class=\"md-icon-button\"\n                                   ng-if=\"!$ctrl.collapsed\" ng-click=\"$event.stopPropagation(); $ctrl.collapse()\">\n                            <md-icon> arrow_drop_down </md-icon>\n                        </md-button>\n                        <md-button aria-label=\"{{'restore' | translate}}\" title=\"{{'restore' | translate}}\" class=\"md-icon-button\"\n                                   ng-if=\"$ctrl.collapsed\" ng-click=\"$event.stopPropagation(); $ctrl.collapse()\">\n                            <md-icon> arrow_drop_up </md-icon>\n                        </md-button>\n                    </md-toolbar-tools>\n                    <div class=\"notebook-report__content__header md-whiteframe-1dp\" layout=\"row\" layout-align=\"start center\">\n                        <span style=\"color: {{$ctrl.config.itemTypes.report.label.color}};\">{{$ctrl.reportItem.content.title}}</span>\n                        <span flex></span>\n                        <md-icon aria-label=\"{{$ctrl.reportItem.content.title}} info\" style=\"color: {{$ctrl.config.itemTypes.report.label.color}};\">\n                            info\n                            <md-tooltip md-direction=\"left\">{{$ctrl.reportItem.content.prompt}}</md-tooltip>\n                        </md-icon>\n                    </div>\n                </md-toolbar>\n                <md-content class=\"notebook-report__content\" flex>\n                    <summernote id=\"{{$ctrl.reportId}}\"\n                                class=\"notebook-item--report__content\"\n                                ng-model=\"$ctrl.reportItemContent\"\n                                ng-change=\"$ctrl.changed($ctrl.reportItemContent)\"\n                                config=\"$ctrl.summernoteOptions\"></summernote>\n                    <notebook-report-annotations annotations=\"$ctrl.latestAnnotations\"\n                                                 has-new=\"$ctrl.hasNewAnnotation\"\n                                                 max-score=\"$ctrl.maxScore\"></notebook-report-annotations>\n                </md-content>\n                <md-card-actions class=\"notebook-report__actions\">\n                    <div id=\"{{$ctrl.reportId}}-toolbar\"></div>\n                    <div layout=\"row\" layout-align=\"start center\">\n                        <md-button class=\"md-primary md-raised button--small\"\n                                   aria-label=\"{{ 'save' | translate }}\"\n                                   ng-disabled=\"!$ctrl.dirty\"\n                                   ng-click=\"$ctrl.saveNotebookReportItem()\">{{ 'save' | translate }}</md-button>\n                        <span ng-show=\"$ctrl.saveMessage.text\"\n                              class=\"component__actions__info md-caption\">\n                              {{$ctrl.saveMessage.text}} <span class=\"component__actions__more\"><md-tooltip md-direction=\"top\">{{ $ctrl.saveMessage.time | amDateFormat:'ddd, MMM D YYYY, h:mm a' }}</md-tooltip><span am-time-ago=\"$ctrl.saveMessage.time\"></span></span>\n                        </span>\n                    </div>\n                </md-card-actions>\n            </md-card>\n        </div>`,\n  controller: NotebookReportController\n};\n\nexport default NotebookReport;\n"]}