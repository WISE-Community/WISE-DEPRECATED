{"version":3,"sources":["audioOscillatorController.es6"],"names":["AudioOscillatorController","$filter","$mdDialog","$q","$rootScope","$scope","$timeout","AnnotationService","AudioOscillatorService","ConfigService","NodeService","NotebookService","ProjectService","StudentAssetService","StudentDataService","UtilService","frequenciesPlayed","frequenciesPlayedSorted","numberOfFrequenciesPlayed","minFrequencyPlayed","maxFrequencyPlayed","latestAnnotations","oscilloscopeId","componentId","initializeDefaultSettings","setButtonTextToPlay","setParametersFromComponentContent","componentState","isStudentMode","hasShowWorkConnectedComponent","componentContent","handleConnectedComponents","componentStateHasStudentWork","setStudentWork","hasConnectedComponent","hasMaxSubmitCount","hasSubmitsLeft","isSubmitButtonDisabled","disableComponentIfNecessary","isGradingMode","isGradingRevisionMode","initializeAudioContext","drawOscilloscopeGrid","isDirty","audioOscillatorController","bind","getComponentState","isSubmit","deferred","defer","getState","action","isSubmitDirty","createComponentState","then","resolve","promise","$broadcast","nodeId","isPlaying","oscillatorType","frequency","oscillatorTypes","oscilloscopeWidth","oscilloscopeHeight","gridCellSize","stopAfterGoodDraw","audioContext","AudioContext","event","args","stop","close","submit","startingFrequency","length","studentData","submitCounter","attachments","processLatestStudentWork","createNewComponentState","componentType","createComponentStateAdditionalProcessing","isAudioPlaying","play","setButtonTextToStop","playStopButtonText","$translate","oscillator","createOscillator","type","value","gain","createGain","destination","analyser","createAnalyser","fftSize","connect","start","goodDraw","drawOscilloscope","addFrequencyPlayed","studentDataChanged","push","makeCopyOfJSONObject","sort","a","b","Math","min","max","ctx","document","getElementById","getContext","width","canvas","height","bufferLength","frequencyBinCount","timeData","Uint8Array","getByteTimeDomainData","lineWidth","strokeStyle","beginPath","sliceWidth","x","v","y","foundFirstRisingZeroCrossing","firstRisingZeroCrossingIndex","isFirstPointDrawn","i","currentY","nextY","lineTo","moveTo","stroke","requestAnimationFrame","fillStyle","fillRect","restartPlayer","componentStates","mergedComponentState","mergedStudentData","c","mergeStudentData","oldStudentData","newStudentData","concat","ComponentController","$inject"],"mappings":"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","file":"audioOscillatorController.js","sourcesContent":["'use strict';\n\nimport ComponentController from \"../componentController\";\n\nclass AudioOscillatorController extends ComponentController {\n  constructor($filter,\n      $mdDialog,\n      $q,\n      $rootScope,\n      $scope,\n      $timeout,\n      AnnotationService,\n      AudioOscillatorService,\n      ConfigService,\n      NodeService,\n      NotebookService,\n      ProjectService,\n      StudentAssetService,\n      StudentDataService,\n      UtilService) {\n    super($filter, $mdDialog, $rootScope, $scope,\n        AnnotationService, ConfigService, NodeService,\n        NotebookService, ProjectService, StudentAssetService,\n        StudentDataService, UtilService);\n    this.$q = $q;\n    this.$timeout = $timeout;\n    this.AudioOscillatorService = AudioOscillatorService;\n    this.frequenciesPlayed = [];\n    this.frequenciesPlayedSorted = [];\n    this.numberOfFrequenciesPlayed = 0;\n    this.minFrequencyPlayed = null;\n    this.maxFrequencyPlayed = null;\n    this.latestAnnotations = null;\n    this.oscilloscopeId = 'oscilloscope' + this.componentId;\n\n    this.initializeDefaultSettings();\n    this.setButtonTextToPlay();\n\n    this.setParametersFromComponentContent();\n    const componentState = this.$scope.componentState;\n\n    if (this.isStudentMode()) {\n      if (this.UtilService.hasShowWorkConnectedComponent(this.componentContent)) {\n        this.handleConnectedComponents();\n      }  else if (this.AudioOscillatorService.componentStateHasStudentWork(componentState, this.componentContent)) {\n        this.setStudentWork(componentState);\n      } else if (this.UtilService.hasConnectedComponent(this.componentContent)) {\n        this.handleConnectedComponents();\n      }\n    } else {\n      if (this.AudioOscillatorService.componentStateHasStudentWork(componentState, this.componentContent)) {\n        this.setStudentWork(componentState);\n      }\n    }\n\n    if (this.hasMaxSubmitCount() && this.hasSubmitsLeft()) {\n      this.isSubmitButtonDisabled = true;\n    }\n\n    this.disableComponentIfNecessary();\n\n    if (!this.isGradingMode() && !this.isGradingRevisionMode()) {\n      this.initializeAudioContext();\n\n      /*\n       * draw the oscilloscope grid after angular has finished rendering\n       * the view. we need to wait until after angular has set the\n       * canvas width and height to draw the grid because setting the\n       * dimensions of the canvas will erase the canvas.\n       */\n      $timeout(() => {this.drawOscilloscopeGrid()}, 0);\n    }\n\n    this.$scope.isDirty = function() {\n      return this.$scope.audioOscillatorController.isDirty;\n    }.bind(this);\n\n    /**\n     * Get the component state from this component. The parent node will\n     * call this function to obtain the component state when it needs to\n     * save student data.\n     * @param isSubmit boolean whether the request is coming from a submit\n     * action (optional; default is false)\n     * @return a component state containing the student data\n     */\n    this.$scope.getComponentState = function(isSubmit) {\n      const deferred = this.$q.defer();\n      let getState = false;\n      let action = 'change';\n\n      if (isSubmit) {\n        if (this.$scope.audioOscillatorController.isSubmitDirty) {\n          getState = true;\n          action = 'submit';\n        }\n      } else {\n        if (this.$scope.audioOscillatorController.isDirty) {\n          getState = true;\n          action = 'save';\n        }\n      }\n\n      if (getState) {\n        this.$scope.audioOscillatorController.createComponentState(action).then((componentState) => {\n          deferred.resolve(componentState);\n        });\n      } else {\n        /*\n         * the student does not have any unsaved changes in this component\n         * so we don't need to save a component state for this component.\n         * we will immediately resolve the promise here.\n         */\n        deferred.resolve();\n      }\n\n      return deferred.promise;\n    }.bind(this);\n\n    this.$rootScope.$broadcast('doneRenderingComponent', { nodeId: this.nodeId, componentId: this.componentId });\n  }\n\n  initializeDefaultSettings() {\n    this.isPlaying = false;\n    this.oscillatorType = 'sine';\n    this.frequency = 440;\n    this.oscillatorTypes = [];\n    this.oscilloscopeWidth = 800;\n    this.oscilloscopeHeight = 400;\n    this.gridCellSize = 50;\n    this.stopAfterGoodDraw = true;\n  }\n\n  initializeAudioContext() {\n    this.audioContext = new AudioContext();\n  }\n\n  cleanupBeforeExiting(event, args) {\n    if (!this.isGradingMode()) {\n      this.stop();\n      this.audioContext.close();\n    }\n  }\n\n  handleNodeSubmit() {\n    this.submit('nodeSubmitButton');\n  }\n\n  setParametersFromComponentContent() {\n    this.frequency = this.componentContent.startingFrequency;\n    this.oscillatorTypes = this.componentContent.oscillatorTypes;\n    if (this.componentContent.oscillatorTypes.length > 0) {\n      this.oscillatorType = this.componentContent.oscillatorTypes[0];\n    }\n    this.oscilloscopeWidth = this.componentContent.oscilloscopeWidth;\n    this.oscilloscopeHeight = this.componentContent.oscilloscopeHeight;\n    this.gridCellSize = this.componentContent.gridCellSize;\n    this.stopAfterGoodDraw = this.componentContent.stopAfterGoodDraw;\n  }\n\n  setStudentWork(componentState) {\n    const studentData = componentState.studentData;\n    if (studentData != null) {\n      this.frequenciesPlayed = studentData.frequenciesPlayed;\n      if (this.frequenciesPlayed.length > 0) {\n        this.frequency = this.frequenciesPlayed[this.frequenciesPlayed.length - 1];\n      }\n      this.frequenciesPlayedSorted = studentData.frequenciesPlayedSorted;\n      this.numberOfFrequenciesPlayed = studentData.numberOfFrequenciesPlayed;\n      this.minFrequencyPlayed = studentData.minFrequencyPlayed;\n      this.maxFrequencyPlayed = studentData.maxFrequencyPlayed;\n      this.submitCounter = studentData.submitCounter;\n      this.attachments = studentData.attachments;\n      this.processLatestStudentWork();\n    }\n  }\n\n  createComponentState(action) {\n    const deferred = this.$q.defer();\n    const componentState = this.NodeService.createNewComponentState();\n    const studentData = {};\n    studentData.frequenciesPlayed = this.frequenciesPlayed;\n    studentData.frequenciesPlayedSorted = this.frequenciesPlayedSorted;\n    studentData.numberOfFrequenciesPlayed = this.numberOfFrequenciesPlayed;\n    studentData.minFrequencyPlayed = this.minFrequencyPlayed;\n    studentData.maxFrequencyPlayed = this.maxFrequencyPlayed;\n    studentData.submitCounter = this.submitCounter;\n    componentState.isSubmit = this.isSubmit;\n    componentState.studentData = studentData;\n    componentState.componentType = 'AudioOscillator';\n    componentState.nodeId = this.nodeId;\n    componentState.componentId = this.componentId;\n    this.isSubmit = false;\n    this.createComponentStateAdditionalProcessing(deferred, componentState, action);\n    return deferred.promise;\n  }\n\n  togglePlay() {\n    if (this.isAudioPlaying()) {\n      this.stop();\n      this.setButtonTextToPlay();\n    } else {\n      this.play();\n      this.setButtonTextToStop();\n    }\n  }\n\n  isAudioPlaying() {\n    return this.isPlaying;\n  }\n\n  setButtonTextToPlay() {\n    this.playStopButtonText = this.$translate('audioOscillator.play');\n  }\n\n  setButtonTextToStop() {\n    this.playStopButtonText = this.$translate('audioOscillator.stop');\n  }\n\n  play() {\n    this.oscillator = this.audioContext.createOscillator();\n    this.oscillator.type = this.oscillatorType;\n    this.oscillator.frequency.value = this.frequency;\n    this.gain = this.audioContext.createGain();\n    this.gain.gain.value = 0.5;\n    this.destination = this.audioContext.destination;\n    this.analyser = this.audioContext.createAnalyser();\n    this.analyser.fftSize = 2048;\n    this.oscillator.connect(this.gain);\n    this.gain.connect(this.destination);\n    this.gain.connect(this.analyser);\n    this.oscillator.start();\n    this.goodDraw = false;\n    this.drawOscilloscope();\n    this.isPlaying = true;\n    this.addFrequencyPlayed(this.frequency);\n    this.studentDataChanged();\n  }\n\n  addFrequencyPlayed(frequency) {\n    this.frequenciesPlayed.push(frequency);\n    this.frequenciesPlayedSorted = this.UtilService.makeCopyOfJSONObject(this.frequenciesPlayed);\n    this.frequenciesPlayedSorted.sort((a, b) => (a - b));\n    this.numberOfFrequenciesPlayed = this.frequenciesPlayed.length;\n    this.minFrequencyPlayed = Math.min(...this.frequenciesPlayed);\n    this.maxFrequencyPlayed = Math.max(...this.frequenciesPlayed);\n  }\n\n  stop() {\n    if (this.oscillator != null) {\n      this.oscillator.stop();\n    }\n    this.isPlaying = false;\n  }\n\n  drawOscilloscope() {\n    const analyser = this.analyser;\n    const ctx = document.getElementById(this.oscilloscopeId).getContext('2d');\n    const width = ctx.canvas.width;\n    const height = ctx.canvas.height;\n\n    // get the number of samples, this will be half the fftSize\n    const bufferLength = analyser.frequencyBinCount;\n\n    // create an array to hold the oscillator data\n    const timeData = new Uint8Array(bufferLength);\n\n    // populate the oscillator data into the timeData array\n    analyser.getByteTimeDomainData(timeData);\n\n    this.drawOscilloscopeGrid();\n\n    // start drawing the audio signal line from the oscillator\n    ctx.lineWidth = 2;\n    ctx.strokeStyle = 'rgb(0, 200, 0)'; // green\n    ctx.beginPath();\n\n    const sliceWidth = width * 1.0 / bufferLength;\n    let x = 0;\n    let v = 0;\n    let y = 0;\n\n    /*\n     * we want to start drawing the audio signal such that the first point\n     * is at 0,0 on the oscilloscope and the signal rises after that.\n     * e.g. pretend the ascii below is a sine wave\n     *   _    _\n     *  / \\  / \\\n     * -------------------\n     *   \\_/  \\_/\n     */\n    let foundFirstRisingZeroCrossing = false;\n    let firstRisingZeroCrossingIndex = null;\n    let isFirstPointDrawn = false;\n\n    /*\n     * loop through all the points and draw the signal from the first\n     * rising zero crossing to the end of the buffer\n     */\n    for (let i = 0; i < bufferLength; i++) {\n      const currentY = timeData[i] - 128;\n      const nextY = timeData[i + 1] - 128;\n\n      // check if the current data point is the first rising zero crossing\n      if (!foundFirstRisingZeroCrossing &&\n        (currentY < 0 || currentY == 0) && nextY > 0) {\n\n        // the point is the first rising zero crossing\n        foundFirstRisingZeroCrossing = true;\n        firstRisingZeroCrossingIndex = i;\n      }\n\n      if (foundFirstRisingZeroCrossing) {\n        /*\n         * we have found the first rising zero crossing so we can start\n         * drawing the points.\n         */\n\n        /*\n         * get the height of the point. we need to perform this\n         * subtraction of 128 to flip the value since canvas\n         * positioning is relative to the upper left corner being 0,0.\n         */\n        v = (128 - (timeData[i] - 128)) / 128.0;\n        y = v * height / 2;\n\n        if (isFirstPointDrawn) {\n          ctx.lineTo(x, y);\n        } else {\n          ctx.moveTo(x, y);\n          isFirstPointDrawn = true;\n        }\n\n        // update the x position we are drawing at\n        x += sliceWidth;\n      }\n    }\n\n    if (firstRisingZeroCrossingIndex > 0 && firstRisingZeroCrossingIndex < 10) {\n      /*\n       * we want the first rising zero crossing index to be close to zero\n       * so that the graph spans almost the whole width of the canvas.\n       * if first rising zero crossing index was close to bufferLength\n       * then we would see a cut off graph.\n       */\n      this.goodDraw = true;\n    }\n\n    ctx.stroke();\n\n    if (!this.stopAfterGoodDraw || (this.stopAfterGoodDraw && !this.goodDraw)) {\n      /*\n       * the draw was not good so we will try to draw it again by\n       * sampling the oscillator again and drawing again. if the\n       * draw was good we will stop drawing.\n       */\n      requestAnimationFrame(() => {\n        this.drawOscilloscope();\n      });\n    }\n  }\n\n  drawOscilloscopeGrid() {\n    const ctx = document.getElementById(this.oscilloscopeId).getContext('2d');\n\n    const width = ctx.canvas.width;\n    const height = ctx.canvas.height;\n    const gridCellSize = this.gridCellSize;\n    ctx.fillStyle = 'white';\n    ctx.fillRect(0, 0, width, height);\n    ctx.lineWidth = 2;\n    ctx.strokeStyle = 'lightgrey';\n    ctx.beginPath();\n\n    let x = 0;\n\n    // draw the vertical lines\n    while (x < width) {\n\n      // draw a vertical line\n      ctx.moveTo(x, 0);\n      ctx.lineTo(x, height);\n\n      // move the x position to the right\n      x += gridCellSize;\n    }\n\n    // start by drawing the line in the middle\n    var y = height / 2;\n\n    // draw the horizontal lines above and including the middle line\n    while (y >= 0) {\n\n      // draw a horizontal line\n      ctx.moveTo(0, y);\n      ctx.lineTo(width, y);\n\n      // move the y position up (this is up because of canvas positioning)\n      y -= gridCellSize;\n    }\n\n    y = height / 2;\n\n    // draw the horizontal lines below the middle line\n    while (y <= height) {\n\n      // draw a horizontal line\n      ctx.moveTo(0, y);\n      ctx.lineTo(width, y);\n\n      // move the y position down (this is down because of canvas positioning)\n      y += gridCellSize;\n    }\n\n    // draw the lines on the canvas\n    ctx.stroke();\n  }\n\n  drawVerticalLine() {\n\n  }\n\n  drawHorizontalLine() {\n\n  }\n\n  \n\n  /**\n   * The oscillator type changed\n   */\n  oscillatorTypeChanged() {\n\n    // clear the grid\n    this.drawOscilloscopeGrid();\n\n    if(this.isAudioPlaying()) {\n      this.restartPlayer();\n    }\n  }\n\n  /**\n   * The frequency changed\n   */\n  frequencyChanged() {\n\n    // clear the grid\n    this.drawOscilloscopeGrid();\n\n    if(this.isAudioPlaying()) {\n      this.restartPlayer();\n    }\n  }\n\n  /**\n   * Restart the player\n   */\n  restartPlayer() {\n    this.stop();\n    this.play();\n  }\n\n  /**\n   * Create a component state with the merged student responses\n   * @param componentStates an array of component states\n   * @return a component state with the merged student responses\n   */\n  createMergedComponentState(componentStates) {\n\n    // create a new component state\n    let mergedComponentState = this.NodeService.createNewComponentState();\n    if (componentStates != null) {\n      let mergedStudentData = {};\n      // loop through all the component states and merge the student data\n      for (let c = 0; c < componentStates.length; c++) {\n        let componentState = componentStates[c];\n        if (componentState != null) {\n          let studentData = componentState.studentData;\n          if (studentData != null) {\n            this.mergeStudentData(mergedStudentData, studentData);\n          }\n        }\n      }\n      mergedComponentState.studentData = mergedStudentData;\n    }\n\n    return mergedComponentState;\n  }\n\n  /**\n   * Merge the values in the student data\n   * @param oldStudentData the old student data we will merge into\n   * @param newStudentData the new student data we will merge\n   * @return the merged student data\n   */\n  mergeStudentData(oldStudentData, newStudentData) {\n\n    if (oldStudentData != null && newStudentData != null) {\n\n      if (oldStudentData.frequenciesPlayed == null) {\n        oldStudentData.frequenciesPlayed = newStudentData.frequenciesPlayed;\n      } else {\n        oldStudentData.frequenciesPlayed = oldStudentData.frequenciesPlayed.concat(newStudentData.frequenciesPlayed);\n      }\n\n      if (oldStudentData.frequenciesPlayedSorted == null) {\n        oldStudentData.frequenciesPlayedSorted = newStudentData.frequenciesPlayed;\n      } else {\n        let frequenciesPlayedSorted = this.UtilService.makeCopyOfJSONObject(oldStudentData.frequenciesPlayed);\n        frequenciesPlayedSorted.sort();\n        oldStudentData.frequenciesPlayedSorted = frequenciesPlayedSorted;\n      }\n\n      if (oldStudentData.numberOfFrequenciesPlayed == null) {\n        oldStudentData.numberOfFrequenciesPlayed = newStudentData.numberOfFrequenciesPlayed;\n      } else {\n        oldStudentData.numberOfFrequenciesPlayed = oldStudentData.numberOfFrequenciesPlayed + newStudentData.numberOfFrequenciesPlayed;\n      }\n\n      if (oldStudentData.minFrequencyPlayed == null) {\n        oldStudentData.minFrequencyPlayed = newStudentData.minFrequencyPlayed;\n      } else {\n        oldStudentData.minFrequencyPlayed = Math.min(oldStudentData.minFrequencyPlayed, newStudentData.minFrequencyPlayed);\n      }\n\n      if (oldStudentData.maxFrequencyPlayed == null) {\n        oldStudentData.maxFrequencyPlayed = newStudentData.maxFrequencyPlayed;\n      } else {\n        oldStudentData.maxFrequencyPlayed = Math.max(oldStudentData.maxFrequencyPlayed, newStudentData.maxFrequencyPlayed);\n      }\n    }\n\n    return oldStudentData;\n  }\n};\n\nAudioOscillatorController.$inject = [\n  '$filter',\n  '$mdDialog',\n  '$q',\n  '$rootScope',\n  '$scope',\n  '$timeout',\n  'AnnotationService',\n  'AudioOscillatorService',\n  'ConfigService',\n  'NodeService',\n  'NotebookService',\n  'ProjectService',\n  'StudentAssetService',\n  'StudentDataService',\n  'UtilService'\n];\n\nexport default AudioOscillatorController;\n"]}