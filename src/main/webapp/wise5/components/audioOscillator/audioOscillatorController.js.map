{"version":3,"sources":["audioOscillatorController.es6"],"names":["AudioOscillatorController","$filter","$mdDialog","$q","$rootScope","$scope","$timeout","AnnotationService","AudioOscillatorService","ConfigService","NodeService","NotebookService","ProjectService","StudentAssetService","StudentDataService","UtilService","frequenciesPlayed","frequenciesPlayedSorted","numberOfFrequenciesPlayed","minFrequencyPlayed","maxFrequencyPlayed","oscilloscopeId","componentId","initializeDefaultSettings","setButtonTextToPlay","setParametersFromComponentContent","componentState","isStudentMode","hasShowWorkConnectedComponent","componentContent","handleConnectedComponents","componentStateHasStudentWork","setStudentWork","hasConnectedComponent","hasMaxSubmitCount","hasSubmitsLeft","isSubmitButtonDisabled","disableComponentIfNecessary","isGradingMode","isGradingRevisionMode","initializeAudioContext","drawOscilloscopeGridAfterTimeout","isDirty","audioOscillatorController","bind","getComponentState","isSubmit","deferred","defer","getState","action","isSubmitDirty","createComponentState","then","resolve","promise","$broadcast","nodeId","isPlaying","oscillatorType","frequency","oscillatorTypes","oscilloscopeWidth","oscilloscopeHeight","gridCellSize","stopAfterGoodDraw","audioContext","AudioContext","drawOscilloscopeGrid","event","args","stop","close","submit","startingFrequency","length","studentData","submitCounter","attachments","processLatestStudentWork","createNewComponentState","componentType","createComponentStateAdditionalProcessing","isAudioPlaying","play","setButtonTextToStop","playStopButtonText","$translate","oscillator","createOscillator","type","value","gain","createGain","destination","analyser","createAnalyser","fftSize","connect","start","goodDraw","drawOscilloscope","addFrequencyPlayed","studentDataChanged","push","makeCopyOfJSONObject","sort","a","b","Math","min","max","startDrawingAudioSignalLine","firstRisingZeroCrossingIndex","drawOscilloscopePoints","isFirstRisingZeroCrossingIndexCloseToZero","isDrawAgain","requestAnimationFrame","bufferLength","frequencyBinCount","timeData","Uint8Array","getByteTimeDomainData","ctx","document","getElementById","getContext","lineWidth","strokeStyle","beginPath","width","canvas","height","getTimeData","sliceWidth","getSliceWidth","x","v","y","foundFirstRisingZeroCrossing","isFirstPointDrawn","i","currentY","nextY","isFirstRisingZeroCrossingPoint","drawPoint","stroke","lineTo","moveTo","fillStyle","fillRect","drawVerticalLines","drawHorizontalLines","drawVerticalLine","drawHorizontalLine","restartPlayer","componentStates","mergedComponentState","mergedStudentData","c","mergeStudentData","existingStudentData","newStudentData","concat","ComponentController","$inject"],"mappings":"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","file":"audioOscillatorController.js","sourcesContent":["'use strict';\n\nimport ComponentController from \"../componentController\";\n\nclass AudioOscillatorController extends ComponentController {\n  constructor($filter,\n      $mdDialog,\n      $q,\n      $rootScope,\n      $scope,\n      $timeout,\n      AnnotationService,\n      AudioOscillatorService,\n      ConfigService,\n      NodeService,\n      NotebookService,\n      ProjectService,\n      StudentAssetService,\n      StudentDataService,\n      UtilService) {\n    super($filter, $mdDialog, $rootScope, $scope,\n        AnnotationService, ConfigService, NodeService,\n        NotebookService, ProjectService, StudentAssetService,\n        StudentDataService, UtilService);\n    this.$q = $q;\n    this.$timeout = $timeout;\n    this.AudioOscillatorService = AudioOscillatorService;\n    this.frequenciesPlayed = [];\n    this.frequenciesPlayedSorted = [];\n    this.numberOfFrequenciesPlayed = 0;\n    this.minFrequencyPlayed = null;\n    this.maxFrequencyPlayed = null;\n    this.oscilloscopeId = 'oscilloscope' + this.componentId;\n\n    this.initializeDefaultSettings();\n    this.setButtonTextToPlay();\n\n    this.setParametersFromComponentContent();\n    const componentState = this.$scope.componentState;\n\n    if (this.isStudentMode()) {\n      if (this.UtilService.hasShowWorkConnectedComponent(this.componentContent)) {\n        this.handleConnectedComponents();\n      }  else if (this.AudioOscillatorService.componentStateHasStudentWork(componentState, this.componentContent)) {\n        this.setStudentWork(componentState);\n      } else if (this.UtilService.hasConnectedComponent(this.componentContent)) {\n        this.handleConnectedComponents();\n      }\n    } else {\n      if (this.AudioOscillatorService.componentStateHasStudentWork(componentState, this.componentContent)) {\n        this.setStudentWork(componentState);\n      }\n    }\n\n    if (this.hasMaxSubmitCount() && this.hasSubmitsLeft()) {\n      this.isSubmitButtonDisabled = true;\n    }\n\n    this.disableComponentIfNecessary();\n\n    if (!this.isGradingMode() && !this.isGradingRevisionMode()) {\n      this.initializeAudioContext();\n      this.drawOscilloscopeGridAfterTimeout();\n    }\n\n    this.$scope.isDirty = function() {\n      return this.$scope.audioOscillatorController.isDirty;\n    }.bind(this);\n\n    /**\n     * Get the component state from this component. The parent node will\n     * call this function to obtain the component state when it needs to\n     * save student data.\n     * @param isSubmit boolean Whether the request is coming from a submit\n     * action (optional; default is false).\n     * @return A component state containing the student data.\n     */\n    this.$scope.getComponentState = function(isSubmit) {\n      const deferred = this.$q.defer();\n      let getState = false;\n      let action = 'change';\n\n      if (isSubmit) {\n        if (this.$scope.audioOscillatorController.isSubmitDirty) {\n          getState = true;\n          action = 'submit';\n        }\n      } else {\n        if (this.$scope.audioOscillatorController.isDirty) {\n          getState = true;\n          action = 'save';\n        }\n      }\n\n      if (getState) {\n        this.$scope.audioOscillatorController.createComponentState(action).then((componentState) => {\n          deferred.resolve(componentState);\n        });\n      } else {\n        /*\n         * The student does not have any unsaved changes in this component\n         * so we don't need to save a component state for this component.\n         * We will immediately resolve the promise here.\n         */\n        deferred.resolve();\n      }\n\n      return deferred.promise;\n    }.bind(this);\n\n    this.$rootScope.$broadcast('doneRenderingComponent', { nodeId: this.nodeId, componentId: this.componentId });\n  }\n\n  initializeDefaultSettings() {\n    this.isPlaying = false;\n    this.oscillatorType = 'sine';\n    this.frequency = 440;\n    this.oscillatorTypes = [];\n    this.oscilloscopeWidth = 800;\n    this.oscilloscopeHeight = 400;\n    this.gridCellSize = 50;\n    this.stopAfterGoodDraw = true;\n  }\n\n  initializeAudioContext() {\n    this.audioContext = new AudioContext();\n  }\n\n  /*\n   * Draw the oscilloscope grid after angular has finished rendering\n   * the view. we need to wait until after angular has set the\n   * canvas width and height to draw the grid because setting the\n   * dimensions of the canvas will erase the canvas.\n   */\n  drawOscilloscopeGridAfterTimeout() {\n    this.$timeout(() => {this.drawOscilloscopeGrid()}, 0);\n  }\n\n  cleanupBeforeExiting(event, args) {\n    if (!this.isGradingMode()) {\n      this.stop();\n      this.audioContext.close();\n    }\n  }\n\n  handleNodeSubmit() {\n    this.submit('nodeSubmitButton');\n  }\n\n  setParametersFromComponentContent() {\n    this.frequency = this.componentContent.startingFrequency;\n    this.oscillatorTypes = this.componentContent.oscillatorTypes;\n    if (this.componentContent.oscillatorTypes.length > 0) {\n      this.oscillatorType = this.componentContent.oscillatorTypes[0];\n    }\n    this.oscilloscopeWidth = this.componentContent.oscilloscopeWidth;\n    this.oscilloscopeHeight = this.componentContent.oscilloscopeHeight;\n    this.gridCellSize = this.componentContent.gridCellSize;\n    this.stopAfterGoodDraw = this.componentContent.stopAfterGoodDraw;\n  }\n\n  setStudentWork(componentState) {\n    const studentData = componentState.studentData;\n    if (studentData != null) {\n      this.frequenciesPlayed = studentData.frequenciesPlayed;\n      if (this.frequenciesPlayed.length > 0) {\n        this.frequency = this.frequenciesPlayed[this.frequenciesPlayed.length - 1];\n      }\n      this.frequenciesPlayedSorted = studentData.frequenciesPlayedSorted;\n      this.numberOfFrequenciesPlayed = studentData.numberOfFrequenciesPlayed;\n      this.minFrequencyPlayed = studentData.minFrequencyPlayed;\n      this.maxFrequencyPlayed = studentData.maxFrequencyPlayed;\n      this.submitCounter = studentData.submitCounter;\n      this.attachments = studentData.attachments;\n      this.processLatestStudentWork();\n    }\n  }\n\n  createComponentState(action) {\n    const deferred = this.$q.defer();\n    const componentState = this.NodeService.createNewComponentState();\n    const studentData = {};\n    studentData.frequenciesPlayed = this.frequenciesPlayed;\n    studentData.frequenciesPlayedSorted = this.frequenciesPlayedSorted;\n    studentData.numberOfFrequenciesPlayed = this.numberOfFrequenciesPlayed;\n    studentData.minFrequencyPlayed = this.minFrequencyPlayed;\n    studentData.maxFrequencyPlayed = this.maxFrequencyPlayed;\n    studentData.submitCounter = this.submitCounter;\n    componentState.isSubmit = this.isSubmit;\n    componentState.studentData = studentData;\n    componentState.componentType = 'AudioOscillator';\n    componentState.nodeId = this.nodeId;\n    componentState.componentId = this.componentId;\n    this.isSubmit = false;\n    this.createComponentStateAdditionalProcessing(deferred, componentState, action);\n    return deferred.promise;\n  }\n\n  togglePlay() {\n    if (this.isAudioPlaying()) {\n      this.stop();\n      this.setButtonTextToPlay();\n    } else {\n      this.play();\n      this.setButtonTextToStop();\n    }\n  }\n\n  isAudioPlaying() {\n    return this.isPlaying;\n  }\n\n  setButtonTextToPlay() {\n    this.playStopButtonText = this.$translate('audioOscillator.play');\n  }\n\n  setButtonTextToStop() {\n    this.playStopButtonText = this.$translate('audioOscillator.stop');\n  }\n\n  play() {\n    this.oscillator = this.audioContext.createOscillator();\n    this.oscillator.type = this.oscillatorType;\n    this.oscillator.frequency.value = this.frequency;\n    this.gain = this.audioContext.createGain();\n    this.gain.gain.value = 0.5;\n    this.destination = this.audioContext.destination;\n    this.analyser = this.audioContext.createAnalyser();\n    this.analyser.fftSize = 2048;\n    this.oscillator.connect(this.gain);\n    this.gain.connect(this.destination);\n    this.gain.connect(this.analyser);\n    this.oscillator.start();\n    this.goodDraw = false;\n    this.isPlaying = true;\n    this.drawOscilloscope();\n    this.addFrequencyPlayed(this.frequency);\n    this.studentDataChanged();\n  }\n\n  addFrequencyPlayed(frequency) {\n    this.frequenciesPlayed.push(frequency);\n    this.frequenciesPlayedSorted = this.UtilService.makeCopyOfJSONObject(this.frequenciesPlayed);\n    this.frequenciesPlayedSorted.sort((a, b) => (a - b));\n    this.numberOfFrequenciesPlayed = this.frequenciesPlayed.length;\n    this.minFrequencyPlayed = Math.min(...this.frequenciesPlayed);\n    this.maxFrequencyPlayed = Math.max(...this.frequenciesPlayed);\n  }\n\n  stop() {\n    if (this.oscillator != null) {\n      this.oscillator.stop();\n    }\n    this.isPlaying = false;\n  }\n\n  drawOscilloscope() {\n    if (!this.isPlaying) {\n      return;\n    }\n\n    this.drawOscilloscopeGrid();\n    this.startDrawingAudioSignalLine();\n    const firstRisingZeroCrossingIndex = this.drawOscilloscopePoints();\n\n    if (this.isFirstRisingZeroCrossingIndexCloseToZero(firstRisingZeroCrossingIndex)) {\n      /*\n       * we want the first rising zero crossing index to be close to zero\n       * so that the graph spans almost the whole width of the canvas.\n       * if the first rising zero crossing index was close to bufferLength\n       * size then we would see a cut off graph.\n       */\n      this.goodDraw = true;\n    }\n\n    if (this.isDrawAgain()) {\n      requestAnimationFrame(() => {\n        this.drawOscilloscope();\n      });\n    }\n  }\n\n  getTimeData() {\n    const bufferLength = this.analyser.frequencyBinCount;\n    const timeData = new Uint8Array(bufferLength);\n    this.analyser.getByteTimeDomainData(timeData);\n    return timeData;\n  }\n\n  startDrawingAudioSignalLine() {\n    const ctx = document.getElementById(this.oscilloscopeId).getContext('2d');\n    ctx.lineWidth = 2;\n    ctx.strokeStyle = 'rgb(0, 200, 0)';\n    ctx.beginPath();\n  }\n\n  getSliceWidth() {\n    const ctx = document.getElementById(this.oscilloscopeId).getContext('2d');\n    const bufferLength = this.analyser.frequencyBinCount;\n    const width = ctx.canvas.width;\n    return width * 1.0 / bufferLength;\n  }\n\n  drawOscilloscopePoints() {\n    const ctx = document.getElementById(this.oscilloscopeId).getContext('2d');\n    const height = ctx.canvas.height;\n    const timeData = this.getTimeData();\n    const sliceWidth = this.getSliceWidth();\n    let x = 0;\n    let v = 0;\n    let y = 0;\n\n    /*\n     * we want to start drawing the audio signal such that the first point\n     * is at 0,0 on the oscilloscope and the signal rises after that.\n     * e.g. pretend the ascii below is a sine wave\n     *  _       _\n     * / \\     / \\\n     * -------------------\n     *     \\_/     \\_/\n     */\n    let foundFirstRisingZeroCrossing = false;\n    let firstRisingZeroCrossingIndex = null;\n    let isFirstPointDrawn = false;\n\n    /*\n     * loop through all the points and draw the signal from the first\n     * rising zero crossing to the end of the buffer\n     */\n    for (let i = 0; i < timeData.length; i++) {\n      const currentY = timeData[i] - 128;\n      const nextY = timeData[i + 1] - 128;\n\n      if (this.isFirstRisingZeroCrossingPoint(foundFirstRisingZeroCrossing, currentY, nextY)) {\n        foundFirstRisingZeroCrossing = true;\n        firstRisingZeroCrossingIndex = i;\n      }\n\n      if (foundFirstRisingZeroCrossing) {\n        /*\n         * get the height of the point. we need to perform this\n         * subtraction of 128 to flip the value since canvas\n         * positioning is relative to the upper left corner being 0,0.\n         */\n        v = (128 - (timeData[i] - 128)) / 128.0;\n        y = v * height / 2;\n        this.drawPoint(ctx, isFirstPointDrawn, x, y);\n        if (!isFirstPointDrawn) {\n          isFirstPointDrawn = true;\n        }\n        x += sliceWidth;\n      }\n    }\n\n    ctx.stroke();\n\n    return firstRisingZeroCrossingIndex;\n  }\n\n  isFirstRisingZeroCrossingPoint(foundFirstRisingZeroCrossing, currentY, nextY) {\n    return !foundFirstRisingZeroCrossing && (currentY < 0 || currentY == 0) && nextY > 0;\n  }\n\n  drawPoint(ctx, isFirstPointDrawn, x, y) {\n    if (isFirstPointDrawn) {\n      ctx.lineTo(x, y);\n    } else {\n      ctx.moveTo(x, y);\n    }\n  }\n\n  isFirstRisingZeroCrossingIndexCloseToZero(firstRisingZeroCrossingIndex) {\n    return firstRisingZeroCrossingIndex > 0 && firstRisingZeroCrossingIndex < 10;\n  }\n\n  isDrawAgain() {\n    return !this.stopAfterGoodDraw || (this.stopAfterGoodDraw && !this.goodDraw);\n  }\n\n  drawOscilloscopeGrid() {\n    const ctx = document.getElementById(this.oscilloscopeId).getContext('2d');\n    const width = ctx.canvas.width;\n    const height = ctx.canvas.height;\n    const gridCellSize = this.gridCellSize;\n    ctx.fillStyle = 'white';\n    ctx.fillRect(0, 0, width, height);\n    ctx.lineWidth = 2;\n    ctx.strokeStyle = 'lightgrey';\n    ctx.beginPath();\n    this.drawVerticalLines(ctx, width, height, gridCellSize);\n    this.drawHorizontalLines(ctx, width, height, gridCellSize);\n    ctx.stroke();\n  }\n\n  drawVerticalLines(ctx, width, height, gridCellSize) {\n    let x = 0;\n    while (x < width) {\n      this.drawVerticalLine(ctx, x, height);\n      x += gridCellSize;\n    }\n  }\n\n  drawVerticalLine(ctx, x, height) {\n    ctx.moveTo(x, 0);\n    ctx.lineTo(x, height);\n  }\n\n  drawHorizontalLines(ctx, width, height, gridCellSize) {\n    // draw the horizontal lines above and including the middle line\n    let y = height / 2;\n    while (y >= 0) {\n      this.drawHorizontalLine(ctx, y, width);\n      y -= gridCellSize;\n    }\n\n    // draw the horizontal lines below the middle line\n    y = height / 2;\n    while (y < height) {\n      this.drawHorizontalLine(ctx, y, width);\n      y += gridCellSize;\n    }\n  }\n\n  drawHorizontalLine(ctx, y, width) {\n    ctx.moveTo(0, y);\n    ctx.lineTo(width, y);\n  }\n\n  oscillatorTypeChanged() {\n    this.drawOscilloscopeGrid();\n\n    if(this.isAudioPlaying()) {\n      this.restartPlayer();\n    }\n  }\n\n  frequencyChanged() {\n    this.drawOscilloscopeGrid();\n    if(this.isAudioPlaying()) {\n      this.restartPlayer();\n    }\n  }\n\n  restartPlayer() {\n    this.stop();\n    this.play();\n  }\n\n  /**\n   * Create a component state with the merged student responses.\n   * @param componentStates An array of component states.\n   * @return A component state with the merged student responses.\n   */\n  createMergedComponentState(componentStates) {\n    const mergedComponentState = this.NodeService.createNewComponentState();\n    if (componentStates != null) {\n      const mergedStudentData = {};\n      for (let c = 0; c < componentStates.length; c++) {\n        const componentState = componentStates[c];\n        if (componentState != null) {\n          let studentData = componentState.studentData;\n          if (studentData != null) {\n            this.mergeStudentData(mergedStudentData, studentData);\n          }\n        }\n      }\n      mergedComponentState.studentData = mergedStudentData;\n    }\n    return mergedComponentState;\n  }\n\n  /**\n   * Merge the values in the student data.\n   * @param existingStudentData The old student data we will merge into.\n   * @param newStudentData The new student data we will merge.\n   * @return The merged student data.\n   */\n  mergeStudentData(existingStudentData, newStudentData) {\n    if (existingStudentData.frequenciesPlayed == null) {\n      existingStudentData.frequenciesPlayed = newStudentData.frequenciesPlayed;\n    } else {\n      existingStudentData.frequenciesPlayed = existingStudentData.frequenciesPlayed.concat(newStudentData.frequenciesPlayed);\n    }\n\n    if (existingStudentData.frequenciesPlayedSorted == null) {\n      existingStudentData.frequenciesPlayedSorted = newStudentData.frequenciesPlayed;\n    } else {\n      let frequenciesPlayedSorted = this.UtilService.makeCopyOfJSONObject(existingStudentData.frequenciesPlayed);\n      frequenciesPlayedSorted.sort();\n      existingStudentData.frequenciesPlayedSorted = frequenciesPlayedSorted;\n    }\n\n    if (existingStudentData.numberOfFrequenciesPlayed == null) {\n      existingStudentData.numberOfFrequenciesPlayed = newStudentData.numberOfFrequenciesPlayed;\n    } else {\n      existingStudentData.numberOfFrequenciesPlayed = existingStudentData.numberOfFrequenciesPlayed + newStudentData.numberOfFrequenciesPlayed;\n    }\n\n    if (existingStudentData.minFrequencyPlayed == null) {\n      existingStudentData.minFrequencyPlayed = newStudentData.minFrequencyPlayed;\n    } else {\n      existingStudentData.minFrequencyPlayed = Math.min(existingStudentData.minFrequencyPlayed, newStudentData.minFrequencyPlayed);\n    }\n\n    if (existingStudentData.maxFrequencyPlayed == null) {\n      existingStudentData.maxFrequencyPlayed = newStudentData.maxFrequencyPlayed;\n    } else {\n      existingStudentData.maxFrequencyPlayed = Math.max(existingStudentData.maxFrequencyPlayed, newStudentData.maxFrequencyPlayed);\n    }\n    return existingStudentData;\n  }\n};\n\nAudioOscillatorController.$inject = [\n  '$filter',\n  '$mdDialog',\n  '$q',\n  '$rootScope',\n  '$scope',\n  '$timeout',\n  'AnnotationService',\n  'AudioOscillatorService',\n  'ConfigService',\n  'NodeService',\n  'NotebookService',\n  'ProjectService',\n  'StudentAssetService',\n  'StudentDataService',\n  'UtilService'\n];\n\nexport default AudioOscillatorController;\n"]}